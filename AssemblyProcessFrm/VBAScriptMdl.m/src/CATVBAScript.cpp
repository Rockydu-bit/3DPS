// COPYRIGHT Dassault Systemes 2015
//===================================================================
//
// CATVBAScript.cpp
// Header definition of CATVBAScript
//
//===================================================================
//
// Usage notes:
//
//===================================================================
//
//  Oct 2015  Creation: Code generated by the CAA wizard  WANGJIAPENG
//===================================================================
#include "CATVBAScript.h"
 
CATImplementClass( CATVBAScript,
                   Implementation, 
                   CATStringObject,
                   CATNull );
 
//-----------------------------------------------------------------------------
// CATVBAScript : constructor
//-----------------------------------------------------------------------------
CATVBAScript::CATVBAScript():
    CATStringObject()
{
	pFile = CATFile::GetInstance();
}

//-----------------------------------------------------------------------------
// CATVBAScript : destructor
//-----------------------------------------------------------------------------
CATVBAScript::~CATVBAScript()
{
}
 
//-----------------------------------------------------------------------------
// CATVBAScript : copy constructor
//-----------------------------------------------------------------------------
CATVBAScript::CATVBAScript(CATVBAScript& original):
   CATStringObject(original)
{
}
 
//-----------------------------------------------------------------------------
// CATVBAScript : equal operator
//-----------------------------------------------------------------------------
CATVBAScript& CATVBAScript::operator=(CATVBAScript& original)
{
   CATStringObject::operator=(original);
   return *this;
}

CATBoolean CATVBAScript::SetScriptContent(CString strPath,CString strName)
{
	CString strScriptPath = _T("C:\\Temp\\ºêÄ¿Â¼1\\CgrConversion.catvbs");
	CString strScriptCode;
	CStdioFile file(strScriptPath,CFile::modeCreate|CFile::modeReadWrite);

	strScriptCode = _T("Language=\"VBSCRIPT\"\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("Sub CATMain()\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("Set PartDocument = CATIA.ActiveDocument\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode.Format(L"PartDocument.ExportData \"%s\\%s.cgr\", \"cgr\"\n",strPath,strName);
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("End Sub");
	file.WriteString(strScriptCode);

	file.Close();

	return TRUE;
}

CATBoolean CATVBAScript::SetScriptContent(CArray<CString,CString>& strPathArray,CString strPath)
{
	CString strScriptPath = _T("C:\\Temp\\ºêÄ¿Â¼1\\CgrConversion.catvbs");
	CString strScriptCode;
	CString strFileName = _T("");
	CStdioFile file(strScriptPath,CFile::modeCreate|CFile::modeReadWrite);

	strScriptCode = _T("Language=\"VBSCRIPT\"\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("Sub CATMain()\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	for (int i=0; i<strPathArray.GetSize(); i++)
	{
		strScriptCode.Format(_T("Set PartDocument = CATIA.Documents.Open(\"%s\")"),strPathArray.GetAt(i));
		file.WriteString(strScriptCode);
		file.WriteString(_T("\n"));

		strFileName = pFile->GetFileName(strPathArray.GetAt(i));
		strFileName = pFile->GetPartName(strFileName);
		strScriptCode.Format(_T("PartDocument.ExportData \"%s\\%s.cgr\", \"cgr\""),strPath,strFileName);
		file.WriteString(strScriptCode);
		file.WriteString(_T("\n"));

		strScriptCode = _T("PartDocument.Close\n");
		file.WriteString(strScriptCode);
		file.WriteString(_T("\n"));
	}

	strScriptCode = _T("End Sub");
	file.WriteString(strScriptCode);

	file.Close();

	return TRUE;
}

CATBoolean CATVBAScript::SetScriptContent(CString strPath,CString strName,int Count,CString strType)
{
	CString strScriptPath = _T("C:\\Temp\\ºêÄ¿Â¼1\\CgrAndHsf.catvbs");
	CString strScriptCode;
	CStdioFile file(strScriptPath,CFile::modeCreate|CFile::modeReadWrite);

	strScriptCode = _T("Language=\"VBSCRIPT\"\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("Sub CATMain()\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("Set PartDocument = CATIA.ActiveDocument\n");
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strName.Format(_T("%s_%d"),strName,Count+1);
	strScriptCode.Format(L"PartDocument.ExportData \"%s\\%s.%s\", \"%s\"\n",strPath,strName,strType,strType);
	file.WriteString(strScriptCode);
	file.WriteString(_T("\n"));

	strScriptCode = _T("End Sub");
	file.WriteString(strScriptCode);

	file.Close();

	return TRUE;
}

void CATVBAScript::ExecuteCATScript(CATUnicodeString strName)
{
	CATScriptUtilities *pScript = new CATScriptUtilities();
	CATVariant VariantReturnValue;
	long ReturnValue;
	ReturnValue = 0;
	HRESULT rc = BuildVariant((const long)ReturnValue,VariantReturnValue);
	rc = CATScriptUtilities::ExecuteScript("C:\\Temp\\ºêÄ¿Â¼1\\",catScriptLibraryTypeDirectory
		,strName,VariantReturnValue,"CATMain",NULL,0,TRUE);
}
